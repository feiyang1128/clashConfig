name: Update Cloudflare IP ranges

on:
  schedule:
    - cron: '*/10 * * * *'  # 每10分钟 执行一次脚本
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  update-ip:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的最新 Ubuntu 环境

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2  # 检出仓库代码

    - name: Update Cloudflare IP ranges
      run: |
        OUTPUT_FILE="./cloudflareip.txt"

        IPv4_URL="https://www.cloudflare.com/ips-v4"
        IPv6_URL="https://www.cloudflare.com/ips-v6"

        # 获取当前北京时间
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

        # 清空输出文件，准备写入
        > $OUTPUT_FILE

        # 开始写入规则的开头部分
        echo "payload:" >> $OUTPUT_FILE

        # 处理 IPv4 IP 段
        echo "Fetching and processing Cloudflare IPv4 IP ranges..."
        curl -s "$IPv4_URL" | grep -oP '(\d+\.\d+\.\d+\.\d+/\d+)' | while IFS= read -r ip; do
          echo "  - '$ip'" >> $OUTPUT_FILE
        done

        # 处理 IPv6 IP 段
        echo "Fetching and processing Cloudflare IPv6 IP ranges..."
        curl -s "$IPv6_URL" | grep -oP '([a-f0-9:]+/\d+)' | while IFS= read -r ip; do
          echo "  - '$ip'" >> $OUTPUT_FILE
        done

        # 添加更新时间注释
        echo "# Last updated: $BEIJING_TIME" >> $OUTPUT_FILE

        # 输出文件内容以调试
        cat $OUTPUT_FILE

        # 检查文件是否有更改
        git diff --quiet $OUTPUT_FILE || (
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add $OUTPUT_FILE
          git commit -m "Update Cloudflare IP ranges"
          git push origin main  # 确保使用正确的分支名
        )
